{% extends "todo/base.html" %}
{% block title %}Task:{{ task.title }}{% endblock %}

{% block extrahead %}
    {{ form.media }}
    {{ merge_form.media }}
{% endblock %}

{% block content %}
    <div class="card-deck">
        <div class="app-card col-sm-7">
            <div class="card-body">
                <div class="content-section-main-title" style="font-size: 20px; color: #d9edf7;">{{ task.title }}</div>
                {% if task.note %}
                    <div class="content-section-title" style="margin: 0;">{{ task.note|safe|urlize|linebreaks }}</div>
                {% endif %}
            </div>
        </div>

        <div class="col-sm-4 p-0">
            <ul>
                <li>
                    <button class="btn btn-sm btn-primary" id="EditTaskButton" type="button"
                            data-toggle="collapse" data-target="#TaskEdit">
                        Edit Task
                    </button>

                    <form method="post" action="{% url "todo:task_toggle_done" task.id %}" role="form" class="d-inline">
                        {% csrf_token %}
                        <div style="display:inline; text-align: center;">
                            <button class="btn btn-info btn-sm" type="submit" name="toggle_done" style="width: auto; margin: 0 10px 0 0; font-size: 14px;">
                                {% if task.completed %} Mark Not Done {% else %} Mark Done {% endif %}
                            </button>
                        </div>
                    </form>

                    <form method="post" action="{% url "todo:delete_task" task.id %}" role="form" class="d-inline">
                        {% csrf_token %}
                        <div style=" display: block; text-align: center;">
                            <button class="btn btn-danger btn-sm" type="submit" name="submit_delete" style="width: auto; margin: 0; font-size: 14px;">
                                Delete
                            </button>
                        </div>
                    </form>
                </li>

                <li>
                    <strong>Assigned to: &nbsp;</strong>
                    {% if task.assigned_to %} {{ task.assigned_to.get_full_name }} {% else %} Anyone {% endif %}
                </li>

                <li>
                    <strong>Reported by: &nbsp;</strong> {{ task.created_by.get_full_name }}
                </li>

                <li>
                    <strong>Due date: &nbsp;</strong> {{ task.due_date }}
                </li>

                {% if task.completed %}
                    <li>
                        <strong>Completed on: &nbsp;</strong> {{ task.completed_date}}
                    </li>
                {% else %}
                    <li>
                        <strong>Completed: &nbsp;</strong> {{ task.completed|yesno:"Yes,No" }}
                    </li>
                {% endif %}

                <li>
                    <strong>In list: &nbsp;</strong>
                    <a href="{% url 'todo:list_detail' task.task_list.id task.task_list.slug %}" style="color: #1496bb; text-decoration: none;">
                        {{ task.task_list }}
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div id="TaskEdit" class="collapse">
        {# Task edit / new task form #}
        {% include 'todo/include/task_edit.html' %}
        {% if merge_form is not None %}
            <form action="" method="post">
                <div class="card border-danger">
                    <div class="card-header" style="color: #2C2C2C; font-size: 18px;">Merge task</div>
                    <div class="card-body">
                        <div class="">
                            <p style="color: #2C2C2C;">Merging is a destructive operation. This task will not exist anymore, and comments will be moved to the target task.</p>
                            {% csrf_token %}
                            {% for field in merge_form.visible_fields %}
                                <p>
                                    {{ field.errors }}
                                    {{ field }}
                                </p>
                            {% endfor %}
                            <input class="d-inline btn btn-sm btn-outline-danger" type="submit" name="merge_task_into" value="Merge">
                        </div>
                    </div>
                </div>
            </form>
        {% endif %}
    </div>

    {% if attachments_enabled %}
        <div class="card mt-4">
            <div class="card-header" style="color: #2C2C2C; font-size: 18px;">Attachments</div>

            <div class="card-body pb-0">
                {% if task.attachment_set.count %}
                    <div class="table-responsive">
                        <table class="table mb-3">
                            <thead>
                            <tr>
                                <th>File</th>
                                <th>Uploaded</th>
                                <th>By</th>
                                <th>Type</th>
                                <th>Remove</th>
                            </tr>
                            </thead>

                            <tbody>
                            {% for attachment in task.attachment_set.all %}
                                <tr>
                                    <td><a style="color: #1496bb;" href="{{ attachment.file.url }}">{{ attachment.filename }}</a></td>
                                    <td>{{ attachment.timestamp }}</td>
                                    <td>{{ attachment.added_by.get_full_name }}</td>
                                    <td>{{ attachment.extension.lower }}</td>
                                    <td>
                                        <form action="{% url "todo:remove_attachment" attachment.id %}" method="POST">
                                            {% csrf_token %}
                                            <input type="submit" value="X" class="btn btn-danger btn-sm" style="width: 50px;">
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}

                <form method="POST" action="" enctype="multipart/form-data" style="width:50%;">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="attachment_file_input" name="attachment_file_input" />
                            <label class="custom-file-label" for="attachment_file_input">Choose file</label>
                        </div>

                        <div class="input-group-append">
                            <button class="btn btn-primary" style="font-size: 14px;">Upload</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    {% endif %}

    <div class="mt-3">
        <div class="content-section-title" style="font-size: 20px; color: white;">Add comment</div>
        <form action="" method="post">
            {% csrf_token %}
            <div class="form-group">
                <textarea class="form-control" name="comment-body" rows="3" required></textarea>
            </div>
            <input class="btn btn-sm btn-primary" type="submit" name="add_comment" value="Add Comment" style="font-size: 16px;">
        </form>
    </div>

    <div class="task_comments mt-4">
        {% if comment_list %}
            <div class="content-section-title" style="font-size: 20px; color: white;">Comments on this task</div>
            {% for comment in comment_list %}
                <div class="mb-3 card">
                    <div class="card-header" style="color: #2C2C2C; font-size: 16px;">
                        <div class="float-left">
                            {% if comment.email_message_id %}
                                <span class="badge badge-warning">email</span>
                            {% endif %}
                            {{ comment.author_text }}
                        </div>

                        <span class="float-right d-inline-block text-muted">
                            {{ comment.date|date:"F d Y P" }}
                        </span>
                    </div>

                    <div class="{{ comment_classes | join:" " }} card-body" style="color: #2C2C2C;">
                        {{ comment.body|safe|urlize|linebreaks }}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="content-section-main-title" style="font-size: 20px;">No comments (yet)</div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
    {# Support file attachment uploader #}
    <script>
        $('#attachment_file_input').on('change',function(){
            // Get the file name and remove browser-added "fakepath". Then replace the "Choose a file" label.
            let fileName = $(this).val().replace('C:\\fakepath\\', " ");
            $(this).next('.custom-file-label').html(fileName);
        })
    </script>
{% endblock extra_js %}

